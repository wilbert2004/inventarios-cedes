# M√≥dulo de Reportes de Ventas

Sistema completo de reportes y an√°lisis de ventas con generaci√≥n de PDFs y b√∫squeda de ventas espec√≠ficas.

## üéØ Caracter√≠sticas

### Funcionalidades Implementadas

‚úÖ **Reportes por Per√≠odo**

- Reporte Diario (√∫ltimas 24 horas)
- Reporte Semanal (√∫ltimos 7 d√≠as)
- Reporte Mensual (√∫ltimos 30 d√≠as)
- Reporte Anual (√∫ltimos 365 d√≠as)
- Filtros de fecha personalizados

‚úÖ **B√∫squeda de Ventas Espec√≠ficas**

- B√∫squeda por ID de venta
- Visualizaci√≥n detallada de productos vendidos
- Informaci√≥n completa del vendedor y m√©todo de pago
- Generaci√≥n de comprobante individual

‚úÖ **An√°lisis y Estad√≠sticas**

- Total vendido en el per√≠odo
- Cantidad de transacciones
- Ticket promedio
- Desglose por fecha
- Agrupaci√≥n autom√°tica por d√≠a

‚úÖ **Generaci√≥n de PDFs**

- Exportaci√≥n de reportes de per√≠odo
- Comprobantes individuales de ventas
- Dise√±o profesional con tablas
- Guardado en ubicaci√≥n elegida por el usuario

## üìã Estructura de Base de Datos

### Consultas Utilizadas

#### Ventas por Rango de Fechas

```sql
SELECT
  s.id,
  s.user_id,
  s.total,
  s.payment_method,
  s.created_at,
  u.name as user_name,
  COUNT(si.id) as item_count
FROM sales s
LEFT JOIN users u ON s.user_id = u.id
LEFT JOIN sale_items si ON s.id = si.sale_id
WHERE DATE(s.created_at) BETWEEN ? AND ?
GROUP BY s.id
ORDER BY s.created_at DESC
```

#### Detalle de Venta Espec√≠fica

```sql
-- Venta principal
SELECT
  s.id,
  s.user_id,
  s.total,
  s.payment_method,
  s.created_at,
  u.name as user_name
FROM sales s
LEFT JOIN users u ON s.user_id = u.id
WHERE s.id = ?

-- Items de la venta
SELECT
  si.id,
  si.product_id,
  si.quantity,
  si.unit_price,
  si.subtotal,
  p.name as product_name
FROM sale_items si
LEFT JOIN products p ON si.product_id = p.id
WHERE si.sale_id = ?
```

#### Estad√≠sticas Diarias

```sql
SELECT
  DATE(s.created_at) as date,
  COUNT(s.id) as transaction_count,
  SUM(s.total) as total_sales,
  AVG(s.total) as average_transaction
FROM sales s
WHERE DATE(s.created_at) BETWEEN ? AND ?
GROUP BY DATE(s.created_at)
ORDER BY DATE(s.created_at) ASC
```

## üîÑ Flujo de Uso

### 1. Reportes por Per√≠odo

1. **Selecci√≥n de Tipo**
   - Usuario elige: Diario/Semanal/Mensual/Anual
   - Se calculan autom√°ticamente las fechas

2. **Filtrado Opcional**
   - Usuario puede ajustar fechas manualmente
   - Sistema recalcula datos al cambiar fechas

3. **Visualizaci√≥n**
   - Tarjetas con estad√≠sticas principales
   - Tabla con desglose por fecha
   - Panel de resumen

4. **Exportaci√≥n**
   - Clic en "Descargar PDF"
   - Seleccionar ubicaci√≥n
   - Sistema genera PDF con todos los datos

### 2. Venta Espec√≠fica

1. **B√∫squeda**
   - Usuario ingresa ID de venta
   - Sistema busca en base de datos

2. **Visualizaci√≥n**
   - Informaci√≥n del encabezado (fecha, vendedor, m√©todo)
   - Tabla detallada de productos
   - Cantidades, precios unitarios y subtotales
   - Total general

3. **Comprobante**
   - Clic en "Descargar PDF"
   - Sistema genera comprobante individual
   - Incluye todos los productos vendidos

## üöÄ API (IPC Handlers)

### `reports:getSalesByDateRange`

Obtiene todas las ventas en un rango de fechas.

**Input:**

```javascript
{
  startDate: '2026-01-01',  // ISO string
  endDate: '2026-01-05'     // ISO string
}
```

**Output:**

```javascript
[
  {
    id: 1,
    user_id: 1,
    total: 95.0,
    payment_method: "cash",
    created_at: "2026-01-05 12:30:45",
    user_name: "Juan P√©rez",
    item_count: 3,
  },
  // ...m√°s ventas
];
```

### `reports:getSaleDetail`

Obtiene detalles completos de una venta espec√≠fica.

**Input:** `saleId: number`

**Output:**

```javascript
{
  id: 1,
  user_id: 1,
  total: 95.00,
  payment_method: 'cash',
  created_at: '2026-01-05 12:30:45',
  user_name: 'Juan P√©rez',
  items: [
    {
      id: 1,
      product_id: 1,
      quantity: 2,
      unit_price: 30.00,
      subtotal: 60.00,
      product_name: 'Coca Cola 600ml'
    },
    // ...m√°s items
  ]
}
```

**Errores:**

- `Sale ID es requerido`
- `Venta con ID [x] no encontrada`

### `reports:getDailyStats`

Obtiene estad√≠sticas agrupadas por d√≠a.

**Input:**

```javascript
{
  startDate: '2026-01-01',
  endDate: '2026-01-05'
}
```

**Output:**

```javascript
[
  {
    date: "2026-01-05",
    transaction_count: 3,
    total_sales: 95.0,
    average_transaction: 31.67,
  },
  // ...m√°s d√≠as
];
```

### `reports:getTopProducts`

Obtiene productos m√°s vendidos en un per√≠odo.

**Input:**

```javascript
{
  startDate: '2026-01-01',
  endDate: '2026-01-05',
  limit: 10  // opcional, default: 10
}
```

**Output:**

```javascript
[
  {
    id: 1,
    name: "Coca Cola 600ml",
    total_quantity: 25,
    total_revenue: 750.0,
    sold_in_transactions: 12,
  },
  // ...m√°s productos
];
```

### `reports:generatePDF`

Genera y guarda un PDF del reporte.

**Input:**

```javascript
{
  reportData: {
    type: 'daily',  // daily | weekly | monthly | yearly | custom
    dateRange: {
      start: Date,
      end: Date
    },
    summary: {
      totalSales: 95.00,
      transactionCount: 3,
      averageTransaction: 31.67
    },
    sales: [...],      // Para reportes de per√≠odo
    saleDetails: [...]  // Para venta espec√≠fica (CUSTOM)
  },
  reportType: 'daily'
}
```

**Output:** `string` (ruta del archivo guardado) o `null` si se cancel√≥

**Formatos:**

- **Reportes de Per√≠odo**: Tabla de transacciones con resumen estad√≠stico
- **Venta Espec√≠fica**: Comprobante con tabla de productos

## üé® Componentes

### ReportsView

Componente principal que orquesta todo el m√≥dulo.

**Estados:**

- `chartData`: Datos procesados para la tabla
- `customSale`: Datos de venta espec√≠fica encontrada

**Funciones principales:**

- `handleCustomSaleFound()`: Procesa venta encontrada
- `processDataForChart()`: Agrupa ventas por fecha
- `loadReportData()`: Carga datos del reporte seleccionado
- `handleDateFilterChange()`: Actualiza fechas y recarga
- `handleDownloadPDF()`: Genera y descarga PDF

### ReportSelector

Botones para seleccionar tipo de reporte.

**Props:**

- `currentType`: Tipo de reporte activo
- `onSelect`: Callback al seleccionar

**Tipos disponibles:**

- `DAILY`: Reporte Diario
- `WEEKLY`: Reporte Semanal
- `MONTHLY`: Reporte Mensual
- `YEARLY`: Reporte Anual
- `CUSTOM`: Venta Espec√≠fica

### ReportFilters

Inputs de fecha para filtrar per√≠odo.

**Props:**

- `dateRange`: `{ start: Date, end: Date }`
- `onDateChange`: Callback al cambiar fechas

**Caracter√≠sticas:**

- Manejo correcto de timezone (sin desfase UTC)
- Validaci√≥n de fechas
- Formato YYYY-MM-DD

### ReportChart

Tabla que muestra datos agrupados por fecha.

**Props:**

- `data`: Array de datos procesados
- `reportType`: Tipo de reporte
- `loading`: Estado de carga

**Columnas:**

- Fecha
- Transacciones
- Total Ventas
- Promedio

### ReportPreview

Panel de resumen con estad√≠sticas y botones.

**Props:**

- `report`: Datos del reporte
- `loading`: Estado de carga
- `onDownloadPDF`: Callback para descargar

**Tarjetas:**

- Total Vendido (verde)
- Transacciones (azul)
- Ticket Promedio (naranja)

### SaleSearchBar

Buscador de ventas espec√≠ficas.

**Props:**

- `onSaleFound`: Callback cuando encuentra venta
- `loading`: Estado de carga

**Caracter√≠sticas:**

- B√∫squeda por ID
- Soporte para Enter
- Manejo de errores
- Validaci√≥n de input

## üì¶ Hook Personalizado

### `useReports()`

**Estados:**

```javascript
{
  currentReportType: 'daily',     // Tipo actual
  reportData: { ... },            // Datos del reporte
  customDateRange: null,          // Fechas personalizadas
  loading: false,
  error: null
}
```

**Funciones:**

```javascript
{
  (getReport(type, dateRange), // Obtener reporte
    setCurrentReportType(type), // Cambiar tipo
    setCustomDateRange(range)); // Establecer fechas custom
}
```

**L√≥gica:**

- Calcula rango de fechas seg√∫n tipo
- Ejecuta consultas IPC
- Procesa estad√≠sticas
- Maneja errores

## üîß Constantes y Tipos

### `reportTypes.js`

**REPORT_TYPES:**

```javascript
{
  DAILY: 'daily',
  WEEKLY: 'weekly',
  MONTHLY: 'monthly',
  YEARLY: 'yearly',
  CUSTOM: 'custom'
}
```

**REPORT_TYPE_LABELS:**

```javascript
{
  daily: 'Reporte Diario',
  weekly: 'Reporte Semanal',
  monthly: 'Reporte Mensual',
  yearly: 'Reporte Anual',
  custom: 'Venta Espec√≠fica'
}
```

**REPORT_DATE_RANGES:**

```javascript
{
  daily: 1,      // d√≠as
  weekly: 7,
  monthly: 30,
  yearly: 365,
  custom: 0      // sin rango fijo
}
```

## üõ†Ô∏è Dependencias

- **jsPDF** (2.5.2): Generaci√≥n de documentos PDF
- **React**: UI y gesti√≥n de estado
- **Tailwind CSS**: Estilos
- **Electron IPC**: Comunicaci√≥n con proceso principal
- **better-sqlite3**: Consultas de base de datos

## üìù Notas T√©cnicas

### Manejo de Timezone

Las fechas se manejan sin conversi√≥n UTC para evitar desfase de d√≠as:

```javascript
// ‚ùå INCORRECTO: new Date('2026-01-05') ‚Üí se interpreta como UTC
// ‚úÖ CORRECTO: parse manual de componentes
const [year, month, day] = dateString.split("-");
const date = new Date(year, month - 1, day);
```

### Transacciones PDF

Los PDFs se generan en el proceso principal (acceso al sistema de archivos):

1. Usuario elige ubicaci√≥n con `dialog.showSaveDialog()`
2. jsPDF genera el documento en memoria
3. Se guarda como buffer en la ruta elegida
4. Retorna ruta completa al frontend

### Procesamiento de Datos

Los datos de ventas se agrupan por fecha para visualizaci√≥n:

- Se extrae solo la fecha (sin hora)
- Se agrupan transacciones del mismo d√≠a
- Se calculan totales y promedios
- Se ordenan cronol√≥gicamente

## üêõ Errores Comunes

**"no such column: p.sku"**

- Columna removida de consultas SQL
- Soluci√≥n: No usar `p.sku` en queries

**"Fecha desfasada 1 d√≠a"**

- Problema de timezone UTC
- Soluci√≥n: Parse manual de fechas

**"reportTypes no est√° definido"**

- Falta importar en main.js
- Soluci√≥n: `require('./main/ipc/reports.ipc')`

## üöÄ Mejoras Futuras

- [ ] Gr√°ficos visuales (l√≠neas/barras)
- [ ] Exportaci√≥n a Excel
- [ ] Comparaci√≥n entre per√≠odos
- [ ] Reportes por categor√≠a de producto
- [ ] Reportes por vendedor
- [ ] Filtros avanzados (m√©todo de pago, rango de montos)
- [ ] Dashboard con KPIs
- [ ] Exportaci√≥n programada
- [ ] Env√≠o por email
